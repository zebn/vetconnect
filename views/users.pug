extends layout
block content
    .container
        .main-body
            .row.gutters-sm
                .col-md-4.mb-3
                    .card
                        .card-body
                            .d-flex.flex-column.align-items-center.text-center
                                img.rounded-circle(src='/upload/'+userInfo.img alt=userInfo.nickname width='150')
                                .mt-3
                                    span.p-3.py-5
                                        form(action='/users/imagedchange' method='POST' enctype="multipart/form-data")
                                            .form-group
                                                label.labels.mb-1(label-for='profileimage') Cambiar imagen
                                                input#profileimage.form-control(type='file' name='profileimage' accept='image/*' onchange="form.submit()")
                    .card.mt-3
                        .p-3.py-5
                            h5.text-right Cambiar contraseña
                            if (result=="success")
                                .mb-2.text-center.text-success La contraseña ha sido cambiada
                            if (result=="notfound") 
                                .mb-2.text-center.text-danger Contraseñas no coinciden
                            if (result=="notexist") 
                                .mb-2.text-center.text-danger Contraseña no existe
                            form(action='/users/passwordchange', method='POST')
                                .form-group
                                    label.labels(label-for='oldPassword') Contraseña actual
                                    input#oldPassword.form-control(type='password' name='oldPassword'  maxlength="45"  required)
                                .form-group.mt-3
                                    label.labels(label-for='newPassword') Nueva contraseña
                                    input#newPassword.form-control(type='password' name='newPassword'  minlength="8" maxlength="45" pattern="^[A-Za-z0-9_*+?@$!*?&]+$" title="Ingresa letras (mayúsculas y minúsculas), números o los símbolos especiales _+?@$!*?&." required)
                                .form-group.mt-3
                                    label.labels(label-for='confirmPassword') Confirmar nueva contraseña
                                    input#confirmPassword.form-control(type='password' name='confirmPassword' required)
                                .mt-3.text-center
                                    button.btn.btn-primary.profile-button(type='submit') Cambiar contraseña  
                .col-md-8
                    .card.mb-3
                        .card-body
                            .row
                                .col-sm-3
                                    h6.mb-0 Nickname
                                .col-sm-9.text-secondary #{userInfo.nickname}
                            hr
                            .row
                                .col-sm-3
                                    h6.mb-0 Nombre y apellido
                                .col-sm-9.text-secondary #{userInfo.name}
                            hr
                            .row
                                .col-sm-3
                                    h6.mb-0 Correo electronico
                                .col-sm-9.text-secondary #{userInfo.username}
                            if(userInfo.familiarName)
                                hr
                                .row
                                    .col-sm-3
                                        h6.mb-0 Mascota
                                    .col-sm-9.text-secondary #{userInfo.familiarName} 
                                        if(userInfo.familiarType)
                                            span (#{userInfo.familiarType})                              
                            //- hr
                            //- .row
                            //-     .col-sm-12
                            //-         a.btn.btn-info(target='__blank' href='https://www.bootdey.com/snippets/view/profile-edit-data-and-skills') Edit
                    .row.gutters-sm
                        .col-sm-12.mb-3
                            main#main
                                if (chats.length==0&&role=="ROLE_USER")
                                    button#createButton.btn.btn-primary(type='button' onclick='createRoom()') Nueva consulta
                                if (chats.length==0&&chatsWithoutDoctor.length==0&&(role=="ROLE_DOCTOR"||role=="ROLE_ADMIN"))
                                    h2 No hay consultas
                                if (chats.length>0)                
                                    h2 Mis consultas
                                    .row
                                        each chat in chats
                                            .col-lg-4.mt-3
                                                .card.text-bg-light.mb-3(style='max-width: 18rem;')
                                                    .card-header #{chat.nameChat}
                                                    .card-body
                                                        p.card-text Consulta en progreso
                                                        form(action="/users/finalize/"+chat.idChat method="POST")
                                                            a.btn.btn-primary(href="/chat/"+chat.idChat) Unir                                                
                                                            button(type="submit").btn.btn-danger.ms-1 Finalizar    
                                if (chatsWithoutDoctor.length>0&&(role=="ROLE_DOCTOR"||role=="ROLE_ADMIN"))
                                    h2 Consultas sin atención
                                    .row
                                        each chatWithoutDoctor in chatsWithoutDoctor
                                            .col-lg-4.mt-3
                                                .card.text-bg-light.mb-3.h-100.align-items-start(style='max-width: 18rem;')
                                                    .card-header #{chatWithoutDoctor.nameChat}
                                                    .card-body
                                                        p.card-text.text-danger Consulta pendiente
                                                        form(action="/users/finalize/"+chatWithoutDoctor.idChat method="POST")
                                                            a.btn.btn-primary(href="/chat/"+chatWithoutDoctor.idChat) Unir
                                                            button(type="submit").btn.btn-danger.ms-1 Finalizar
                                                                if (chatsWithoutDoctor.length>0&&(role=="ROLE_DOCTOR"||role=="ROLE_ADMIN"))
                                h2 Consultas finalizadas
                                .row
                                    each chatFinished in chatsFinished
                                        .col-lg-4.mt-3
                                            .card.text-bg-light.mb-3.opacity-50(style='max-width: 18rem;')
                                                .card-header #{chatFinished.nameChat}
                                                .card-body
                                                    p.card-text Consulta finalizada
                                                    form(action="/users/finalize/"+chatFinished.idChat method="POST")
                                                        a.btn.btn-primary(href="/chat/"+chatFinished.idChat) Ver historia                                                          
    script(src='https://cdn.socket.io/4.7.2/socket.io.min.js')
    script.
        console.log(#{roomId});
        function createRoom()
        {
        const socket = io().connect();
        let roomId = '#{roomId}';
        let nickname = '#{userInfo.nickname}';
        let userId = '#{userId}';  
        dataConnection = {nickname: nickname, userId: userId,socketId:socket.id};
        if (socket && userId) 
        socket.emit('create', dataConnection, (response) => {
        document.getElementById("createButton").remove();
        console.log(response.roomName);
        const main = document.getElementById("main");
        // Create div element with class 'card text-dark bg-light mb-3'
        const cardDiv = document.createElement('div');
        cardDiv.className = 'card text-dark bg-light mb-3';
        cardDiv.style.maxWidth = '18rem';
        // Create div element with class 'card-header' and set its text content
        const cardHeader = document.createElement('div');
        cardHeader.className = 'card-header';
        cardHeader.textContent = response.roomName;
        // Create div element with class 'card-body'
        const cardBodyDiv = document.createElement('div');
        cardBodyDiv.className = 'card-body';
        // Create h5 element with class 'card-title' and set its text content
        const cardTitle = document.createElement('h5');
        cardTitle.className = 'card-title';
        cardTitle.textContent = 'Light card title';
        // Create p element with class 'card-text' and set its text content
        const cardText = document.createElement('p');
        cardText.className = 'card-text';
        cardText.textContent = response.roomName;
        // Create a element with class 'btn btn-primary' and set its attributes
        const link = document.createElement('a');
        link.href = "/chat/"+response.roomId;
        link.className = 'btn btn-primary';
        link.textContent = 'Unir consulta';
        // Append all the created elements to the appropriate parent elements
        cardDiv.appendChild(cardHeader);
        cardDiv.appendChild(cardBodyDiv);
        cardBodyDiv.appendChild(cardTitle);
        cardBodyDiv.appendChild(cardText);
        cardBodyDiv.appendChild(link);
        // Append the cardDiv to the document body or any other desired parent element
        main.appendChild(cardDiv);
        }); 
        }